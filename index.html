<html>
<head>
	<script type='text/javascript' ></script>
	<style type='text/css'>
    #editor { 
        /*position: absolute;*/
        /*top: 0;*/
        /*right: 0;*/
        /*bottom: 0;*/
        /*left: 0;*/
        width: 50%;
        height: 100%;
    }
	#results {
    	width: 50%;
    	height: 100%;
    	float: right;
    }
    #latex_output_img {
    	width: 100%;
    	height: 50%;
    	/*border: 1px solid black;*/
    	float: none;
    	background: no-repeat 10px 10px;
    }
    #wordpress {
    	width: 100%;
    	height: 50%;
    	/*border: 1px solid black;*/
    	float: none;
    }
    #conv_from_wordpress {
    	display: block;
    	/*float: left;*/
    }
    #wordpress_out {
    	/*float: left;*/
    	display: block;
    	width: 100%;
    } 
	</style>
</head>
<body>
	<div id='results'> 
		<div id='latex_output_img'>
		
		</div>
		<div id='wordpress'>
			<div style="padding: 10px;">
			<hr/>
			Copy &amp; Paste this into wordpress
			<br />
			<input type='text' id='wordpress_out' value='test' />
			<button id='conv_from_wordpress'>Extract Latex from Wordpress</button>
			<br />
			<a href='http://en.support.wordpress.com/latex/'>Help Site for Wordpress.com Latex-Processor</a>
			</div>
		</div>
	</div>
	<div id='editor'>
	    \epsilon
	</div>
	<script src='js/jquery-2.0.3.min.js' type='text/javascript' charset='utf-8'></script>
	<script src='js/ace/ace.js' type='text/javascript' charset='utf-8'></script>
	<script>
	    var editor = ace.edit('editor');
	    editor.setTheme('ace/theme/monokai');
	    editor.getSession().setMode('ace/mode/latex');

	    var get_latex_output_url = function(latex) {
	    	return 'http://s0.wp.com/latex.php?bg=ffffff&fg=000&s=1&latex=' + encodeURIComponent(latex);
	    };

	    var get_wordpress_output = function (url) {
	    	return '<img src="' + url + '" />';
	    }

	    var change_latex = function(latex) {
	    	// Get image url from latex processor
	    	url = get_latex_output_url(latex);

	    	// Set preview image
	    	$('#latex_output_img').css('background-image',"url('"+url+"')");
	    	
	    	// Set output text for copy&pasting into wordpress
	    	$('#wordpress_out').attr('value',get_wordpress_output(url));
	    };

	    var get_editor_latex = function() {
	    	latex = editor.getValue();
	    	latex = latex.trim()
	    	return latex;
	    }

	    function getURLParameter(url, name) {
	    	// derived from http://stackoverflow.com/a/1404100/798588
		    return decodeURIComponent(
		        (RegExp(name + '=' + '(.+?)(&|$)').exec(url)||[,null])[1]
		    );
		}

	    var get_latex_from_wordpress = function(html) {
	    	start = html.indexOf('http://s0.wp.com');
	    	end = html.indexOf('"',start);
	    	url = html.substr(start,end-start);
	    	return getURLParameter(url,'latex');
	    }

	    editor.on('change', function(e) {
	    	change_latex(get_editor_latex());

	    });

	    $('#conv_from_wordpress').on('click', function(e) {
	    	editor.setValue(get_latex_from_wordpress($('#wordpress_out').attr('value')));
	    })

	    change_latex(get_editor_latex());
	</script>
</body>
</html>